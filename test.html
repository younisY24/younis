<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>خريطة الحرب الصينية اليابانية WWII - يوم بيوم</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; font-family: system-ui, Arial; direction: rtl; }
  #map { position: absolute; top:0; bottom:120px; left:0; right:0; }
  #controls { position:absolute; bottom:0; left:10px; right:10px; height:120px;
              background: rgba(255,255,255,0.95); border-radius:8px; padding:8px; display:flex; flex-direction:column; justify-content:center; gap:8px;}
  #legend { position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.9); padding:8px; border-radius:6px; }
  #dateLabel { font-weight:600; font-size:18px; }
  .eventPopup { font-size:13px; }
</style>
</head>
<body>

<div id="map"></div>
<div id="controls">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <button id="playBtn">تشغيل ▶</button>
    <button id="pauseBtn" style="display:none;">إيقاف ⏸</button>
    <div id="dateLabel">1937-07-07</div>
  </div>
  <input type="range" min="0" max="0" step="1" value="0" id="timeSlider" style="width:100%">
</div>

<div id="legend">
  <b>مفتاح الخريطة</b><br/>
  <span style="color:red;">■ الصين</span><br/>
  <span style="color:blue;">■ اليابان / مناطق السيطرة</span><br/>
  <span>📝 الأحداث اليومية</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
// --- الخريطة ---
const map = L.map('map').setView([35,115], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- حدود الصين واليابان ---
const chinaBounds = [[18,73],[54,135]];
const japanBounds = [[30,128],[46,146]];

// --- أحداث يومية (مثال مبسط) ---
const dailyEvents = [
  {date:"1937-07-07", desc:"حادثة جسر ماركو بولو — بداية الحرب"},
  {date:"1937-08-13", desc:"معركة شنغهاي"},
  {date:"1937-12-13", desc:"مذبحة نانجينغ"},
  {date:"1938-10-01", desc:"معركة ووهان"},
  {date:"1941-12-07", desc:"هجوم بيرل هاربر (للسياق العالمي)"}
];

// --- توسع اليابان يومياً (مربعات تقريبية) ---
const japanDaily = {
  "1937-07-07":[[30,115],[31,117]],
  "1937-08-13":[[30,115],[32,121]],
  "1937-12-13":[[31,118],[32,119]],
  "1938-10-01":[[30,112],[32,115]],
  "1941-12-07":[[21,107],[24,111]]
};

// --- إنشاء أيام كاملة ---
const parseDate = d3.timeParse("%Y-%m-%d");
const formatDate = d3.timeFormat("%Y-%m-%d");
const startDate = parseDate("1937-07-07");
const endDate = parseDate("1945-08-15");
const allDates = d3.timeDay.range(startDate, endDate);

// --- ضبط السلايدر ---
const slider = document.getElementById('timeSlider');
slider.min = 0;
slider.max = allDates.length-1;
slider.value = 0;

// --- الطبقات ---
let chinaLayer, japanLayer, expansionLayer, eventPopup;

// --- رسم حسب اليوم ---
function drawMap(idx){
  const day = allDates[idx];
  const dayStr = formatDate(day);

  if(chinaLayer) map.removeLayer(chinaLayer);
  if(japanLayer) map.removeLayer(japanLayer);
  if(expansionLayer) map.removeLayer(expansionLayer);
  if(eventPopup) map.removeLayer(eventPopup);

  // الصين
  chinaLayer = L.rectangle(chinaBounds, {color:"red", weight:1, fillColor:"red", fillOpacity:0.3}).addTo(map);
  // اليابان
  japanLayer = L.rectangle(japanBounds, {color:"blue", weight:1, fillColor:"blue", fillOpacity:0.3}).addTo(map);

  // مناطق السيطرة اليومية
  if(japanDaily[dayStr]){
    expansionLayer = L.rectangle(japanDaily[dayStr], {color:"blue", weight:1, fillOpacity:0.5}).addTo(map);
  }

  // أحداث اليوم
  const ev = dailyEvents.find(e=>e.date===dayStr);
  if(ev){
    eventPopup = L.popup({closeOnClick:false, autoClose:false})
      .setLatLng([35,115])
      .setContent(`<div class="eventPopup"><b>${dayStr}</b><br/>${ev.desc}</div>`)
      .openOn(map);
  }

  document.getElementById('dateLabel').textContent = dayStr;
}

// --- السلايدر ---
slider.addEventListener('input', e=> drawMap(e.target.value));

// --- تشغيل/إيقاف ---
let timer=null;
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');

function play(){
  playBtn.style.display='none';
  pauseBtn.style.display='inline';
  let idx = parseInt(slider.value);
  timer = setInterval(()=>{
    if(idx >= allDates.length-1){
      clearInterval(timer);
      playBtn.style.display='inline';
      pauseBtn.style.display='none';
      return;
    }
    idx++;
    slider.value = idx;
    drawMap(idx);
  }, 200); // 200ms لكل يوم
}

function pause(){
  clearInterval(timer);
  playBtn.style.display='inline';
  pauseBtn.style.display='none';
}

playBtn.addEventListener('click', play);
pauseBtn.addEventListener('click', pause);

// --- أول عرض ---
drawMap(0);

</script>
</body>
</html>
