<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø¨ Ø§Ù„ØµÙŠÙ†ÙŠØ© Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ÙŠØ© WWII - Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; font-family: system-ui, Arial; direction: rtl; }
  #map { position: absolute; top:0; bottom:120px; left:0; right:0; }
  #controls { position:absolute; bottom:0; left:10px; right:10px; height:120px;
              background: rgba(255,255,255,0.95); border-radius:8px; padding:8px; display:flex; flex-direction:column; justify-content:center; gap:8px;}
  #legend { position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.9); padding:8px; border-radius:6px; }
  #dateLabel { font-weight:600; font-size:18px; }
  .eventPopup { font-size:13px; }
</style>
</head>
<body>

<div id="map"></div>
<div id="controls">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <button id="playBtn">ØªØ´ØºÙŠÙ„ â–¶</button>
    <button id="pauseBtn" style="display:none;">Ø¥ÙŠÙ‚Ø§Ù â¸</button>
    <div id="dateLabel">1937-07-07</div>
  </div>
  <input type="range" min="0" max="0" step="1" value="0" id="timeSlider" style="width:100%">
</div>

<div id="legend">
  <b>Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</b><br/>
  <span style="color:red;">â–  Ù…Ù†Ø§Ø·Ù‚ ØªØ­Ø±ÙŠØ± / Ù…Ù‚Ø§ÙˆÙ…Ø©</span><br/>
  <span style="color:blue;">â–  Ù…Ù†Ø§Ø·Ù‚ Ø§Ø­ØªÙ„Ø§Ù„ ÙŠØ§Ø¨Ø§Ù†ÙŠ</span><br/>
  <span>ğŸ“ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
// --- Ø§Ù„Ø®Ø±ÙŠØ·Ø© ---
const map = L.map('map').setView([35,115], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- Ø¨ÙŠØ§Ù†Ø§Øª ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ù„ÙˆÙ†Ø© (Ø§Ø­ØªÙ„Ø§Ù„/ØªØ­Ø±ÙŠØ±) ---
// ÙƒÙ„ ÙŠÙˆÙ… ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù†Ø§Ø·Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø¹ Ø§Ù„Ù„ÙˆÙ†
const dailyAreas = {
  "1937-07-07":[{bounds:[[30,115],[31,117]], color:"blue", desc:"Ø§Ø­ØªÙ„Ø§Ù„ Ø§Ù„ÙŠØ§Ø¨Ø§Ù† Ù…Ù†Ø·Ù‚Ø© ØµØºÙŠØ±Ø©"}],
  "1937-08-13":[{bounds:[[30,115],[32,121]], color:"blue", desc:"ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø§Ø­ØªÙ„Ø§Ù„ Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ÙŠ"}],
  "1937-12-13":[{bounds:[[31,118],[32,119]], color:"red", desc:"ØªØ­Ø±ÙŠØ± Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / Ù…Ù‚Ø§ÙˆÙ…Ø©"}],
  "1938-10-01":[{bounds:[[30,112],[32,115]], color:"blue", desc:"Ø§Ø­ØªÙ„Ø§Ù„ Ø¬Ø¯ÙŠØ¯"}],
  "1941-12-07":[{bounds:[[21,107],[24,111]], color:"blue", desc:"Ø§Ø­ØªÙ„Ø§Ù„ Ø¬Ø¯ÙŠØ¯"}]
};

// --- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙŠØ§Ù… ---
const parseDate = d3.timeParse("%Y-%m-%d");
const formatDate = d3.timeFormat("%Y-%m-%d");
const startDate = parseDate("1937-07-07");
const endDate = parseDate("1945-08-15");
const allDates = d3.timeDay.range(startDate, endDate);

// --- Ø¶Ø¨Ø· Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± ---
const slider = document.getElementById('timeSlider');
slider.min = 0;
slider.max = allDates.length-1;
slider.value = 0;

// --- Ø§Ù„Ø·Ø¨Ù‚Ø§Øª ---
let activeLayers = [];
let eventPopup;

// --- Ø±Ø³Ù… Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ… ---
function drawMap(idx){
  const day = allDates[idx];
  const dayStr = formatDate(day);

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  activeLayers.forEach(l=>map.removeLayer(l));
  activeLayers = [];
  if(eventPopup) map.removeLayer(eventPopup);

  // Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ÙŠÙˆÙ…
  const areas = dailyAreas[dayStr];
  if(areas){
    areas.forEach(a=>{
      const layer = L.rectangle(a.bounds, {color:a.color, weight:1, fillColor:a.color, fillOpacity:0.5}).addTo(map);
      activeLayers.push(layer);
      // Ø¥Ø¶Ø§ÙØ© Ù†Ø§ÙØ°Ø© popup
      eventPopup = L.popup({closeOnClick:false, autoClose:false})
        .setLatLng([35,115])
        .setContent(`<div class="eventPopup"><b>${dayStr}</b><br/>${a.desc}</div>`)
        .openOn(map);
    });
  }

  document.getElementById('dateLabel').textContent = dayStr;
}

// --- Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± ---
slider.addEventListener('input', e=> drawMap(e.target.value));

// --- ØªØ´ØºÙŠÙ„ / Ø¥ÙŠÙ‚Ø§Ù ---
let timer=null;
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');

function play(){
  playBtn.style.display='none';
  pauseBtn.style.display='inline';
  let idx = parseInt(slider.value);
  timer = setInterval(()=>{
    if(idx >= allDates.length-1){
      clearInterval(timer);
      playBtn.style.display='inline';
      pauseBtn.style.display='none';
      return;
    }
    idx++;
    slider.value = idx;
    drawMap(idx);
  }, 200); // 200ms Ù„ÙƒÙ„ ÙŠÙˆÙ…
}

function pause(){
  clearInterval(timer);
  playBtn.style.display='inline';
  pauseBtn.style.display='none';
}

playBtn.addEventListener('click', play);
pauseBtn.addEventListener('click', pause);

// --- Ø£ÙˆÙ„ Ø¹Ø±Ø¶ ---
drawMap(0);

</script>
</body>
</html>
