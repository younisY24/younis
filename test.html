<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø¨ Ø§Ù„ØµÙŠÙ†ÙŠØ© Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ÙŠØ© WWII - ÙŠÙˆÙ… Ø¨ÙŠÙˆÙ…</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; font-family: system-ui, Arial; direction: rtl; }
  #map { position: absolute; top:0; bottom:120px; left:0; right:0; }
  #controls { position:absolute; bottom:0; left:10px; right:10px; height:120px;
              background: rgba(255,255,255,0.95); border-radius:8px; padding:8px; display:flex; flex-direction:column; justify-content:center; gap:8px;}
  #legend { position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.9); padding:8px; border-radius:6px; }
  #dateLabel { font-weight:600; font-size:18px; }
  .eventPopup { font-size:13px; }
</style>
</head>
<body>

<div id="map"></div>
<div id="controls">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <button id="playBtn">ØªØ´ØºÙŠÙ„ â–¶</button>
    <button id="pauseBtn" style="display:none;">Ø¥ÙŠÙ‚Ø§Ù â¸</button>
    <div id="dateLabel">1937-07-07</div>
  </div>
  <input type="range" min="0" max="0" step="1" value="0" id="timeSlider" style="width:100%">
</div>

<div id="legend">
  <b>Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</b><br/>
  <span style="color:red;">â–  Ø§Ù„ØµÙŠÙ†</span><br/>
  <span style="color:blue;">â–  Ø§Ù„ÙŠØ§Ø¨Ø§Ù† / Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³ÙŠØ·Ø±Ø©</span><br/>
  <span>ğŸ“ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
// --- Ø§Ù„Ø®Ø±ÙŠØ·Ø© ---
const map = L.map('map').setView([35,115], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙŠÙ† ÙˆØ§Ù„ÙŠØ§Ø¨Ø§Ù† ---
const chinaBounds = [[18,73],[54,135]];
const japanBounds = [[30,128],[46,146]];

// --- Ø£Ø­Ø¯Ø§Ø« ÙŠÙˆÙ…ÙŠØ© (Ù…Ø«Ø§Ù„ Ù…Ø¨Ø³Ø·) ---
const dailyEvents = [
  {date:"1937-07-07", desc:"Ø­Ø§Ø¯Ø«Ø© Ø¬Ø³Ø± Ù…Ø§Ø±ÙƒÙˆ Ø¨ÙˆÙ„Ùˆ â€” Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø±Ø¨"},
  {date:"1937-08-13", desc:"Ù…Ø¹Ø±ÙƒØ© Ø´Ù†ØºÙ‡Ø§ÙŠ"},
  {date:"1937-12-13", desc:"Ù…Ø°Ø¨Ø­Ø© Ù†Ø§Ù†Ø¬ÙŠÙ†Øº"},
  {date:"1938-10-01", desc:"Ù…Ø¹Ø±ÙƒØ© ÙˆÙˆÙ‡Ø§Ù†"},
  {date:"1941-12-07", desc:"Ù‡Ø¬ÙˆÙ… Ø¨ÙŠØ±Ù„ Ù‡Ø§Ø±Ø¨Ø± (Ù„Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ)"}
];

// --- ØªÙˆØ³Ø¹ Ø§Ù„ÙŠØ§Ø¨Ø§Ù† ÙŠÙˆÙ…ÙŠØ§Ù‹ (Ù…Ø±Ø¨Ø¹Ø§Øª ØªÙ‚Ø±ÙŠØ¨ÙŠØ©) ---
const japanDaily = {
  "1937-07-07":[[30,115],[31,117]],
  "1937-08-13":[[30,115],[32,121]],
  "1937-12-13":[[31,118],[32,119]],
  "1938-10-01":[[30,112],[32,115]],
  "1941-12-07":[[21,107],[24,111]]
};

// --- Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠØ§Ù… ÙƒØ§Ù…Ù„Ø© ---
const parseDate = d3.timeParse("%Y-%m-%d");
const formatDate = d3.timeFormat("%Y-%m-%d");
const startDate = parseDate("1937-07-07");
const endDate = parseDate("1945-08-15");
const allDates = d3.timeDay.range(startDate, endDate);

// --- Ø¶Ø¨Ø· Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± ---
const slider = document.getElementById('timeSlider');
slider.min = 0;
slider.max = allDates.length-1;
slider.value = 0;

// --- Ø§Ù„Ø·Ø¨Ù‚Ø§Øª ---
let chinaLayer, japanLayer, expansionLayer, eventPopup;

// --- Ø±Ø³Ù… Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ… ---
function drawMap(idx){
  const day = allDates[idx];
  const dayStr = formatDate(day);

  if(chinaLayer) map.removeLayer(chinaLayer);
  if(japanLayer) map.removeLayer(japanLayer);
  if(expansionLayer) map.removeLayer(expansionLayer);
  if(eventPopup) map.removeLayer(eventPopup);

  // Ø§Ù„ØµÙŠÙ†
  chinaLayer = L.rectangle(chinaBounds, {color:"red", weight:1, fillColor:"red", fillOpacity:0.3}).addTo(map);
  // Ø§Ù„ÙŠØ§Ø¨Ø§Ù†
  japanLayer = L.rectangle(japanBounds, {color:"blue", weight:1, fillColor:"blue", fillOpacity:0.3}).addTo(map);

  // Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
  if(japanDaily[dayStr]){
    expansionLayer = L.rectangle(japanDaily[dayStr], {color:"blue", weight:1, fillOpacity:0.5}).addTo(map);
  }

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙŠÙˆÙ…
  const ev = dailyEvents.find(e=>e.date===dayStr);
  if(ev){
    eventPopup = L.popup({closeOnClick:false, autoClose:false})
      .setLatLng([35,115])
      .setContent(`<div class="eventPopup"><b>${dayStr}</b><br/>${ev.desc}</div>`)
      .openOn(map);
  }

  document.getElementById('dateLabel').textContent = dayStr;
}

// --- Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± ---
slider.addEventListener('input', e=> drawMap(e.target.value));

// --- ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù ---
let timer=null;
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');

function play(){
  playBtn.style.display='none';
  pauseBtn.style.display='inline';
  let idx = parseInt(slider.value);
  timer = setInterval(()=>{
    if(idx >= allDates.length-1){
      clearInterval(timer);
      playBtn.style.display='inline';
      pauseBtn.style.display='none';
      return;
    }
    idx++;
    slider.value = idx;
    drawMap(idx);
  }, 200); // 200ms Ù„ÙƒÙ„ ÙŠÙˆÙ…
}

function pause(){
  clearInterval(timer);
  playBtn.style.display='inline';
  pauseBtn.style.display='none';
}

playBtn.addEventListener('click', play);
pauseBtn.addEventListener('click', pause);

// --- Ø£ÙˆÙ„ Ø¹Ø±Ø¶ ---
drawMap(0);

</script>
</body>
</html>
