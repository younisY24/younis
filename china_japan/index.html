<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>حرب الصين واليابان WWII - خريطة يومية بالعربي</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; font-family: Arial; direction: rtl; }
  #map { position:absolute; top:0; bottom:120px; left:0; right:0; }
  #controls { position:absolute; bottom:0; left:10px; right:10px; height:120px;
              background: rgba(255,255,255,0.95); border-radius:8px; padding:8px; display:flex; flex-direction:column; justify-content:center; gap:8px;}
  #dateLabel { font-weight:600; font-size:18px; }
</style>
</head>
<body>
<div id="map"></div>
<div id="controls">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <button id="playBtn">تشغيل ▶</button>
    <button id="pauseBtn" style="display:none;">إيقاف ⏸</button>
    <div id="dateLabel"></div>
  </div>
  <input type="range" min="0" max="0" step="1" value="0" id="timeSlider" style="width:100%">
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
// --- إعداد الخريطة ---
const map = L.map('map').setView([34.5,116],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- GeoJSON للمناطق بالعربي ---
const geojsonData = {
  "type": "FeatureCollection",
  "features": [
    {"type":"Feature","properties":{"name":"بكين"},"geometry":{"type":"Polygon","coordinates":[[[116,39.5],[116.7,39.5],[116.7,40],[116,40],[116,39.5]]]}},
    {"type":"Feature","properties":{"name":"شنغهاي"},"geometry":{"type":"Polygon","coordinates":[[[121.2,31],[121.7,31],[121.7,31.5],[121.2,31.5],[121.2,31]]]}},
    {"type":"Feature","properties":{"name":"نانجينغ"},"geometry":{"type":"Polygon","coordinates":[[[118.7,31.9],[119.5,31.9],[119.5,32.2],[118.7,32.2],[118.7,31.9]]]}},
    {"type":"Feature","properties":{"name":"ووهان"},"geometry":{"type":"Polygon","coordinates":[[[114,30.4],[114.5,30.4],[114.5,30.8],[114,30.8],[114,30.4]]]}}
  ]
};

// --- إضافة الطبقة الأساسية ---
let geojsonLayer = L.geoJson(geojsonData, {
  style: {color:'gray', weight:1, fillOpacity:0},
  onEachFeature: function(feature, layer){
    layer.areaName = feature.properties.name;
    layer.currentControl = null;

    // إضافة اسم عربي ثابت فوق المنطقة
    layer.bindTooltip(feature.properties.name, {permanent:true, direction:'center', className:'areaLabel'});
  }
}).addTo(map);

// --- بيانات يومية للحرب بالعربي ---
const eventsData = {
  "1937-07-07":[{"area":"بكين","control":"اليابان","desc":"اندلاع الحرب عند جسر ماركو بولو"}],
  "1937-07-08":[{"area":"بكين","control":"اليابان","desc":"احتلال جزء من بكين"}],
  "1937-07-09":[{"area":"بكين","control":"اليابان","desc":"سيطرة كاملة على بكين"}],
  "1937-08-13":[{"area":"شنغهاي","control":"اليابان","desc":"احتلال شنغهاي بالكامل"}],
  "1937-12-13":[{"area":"نانجينغ","control":"اليابان","desc":"سقوط نانجينغ ومذبحة المدينة"}],
  "1938-10-01":[{"area":"ووهان","control":"اليابان","desc":"توسيع الاحتلال نحو ووهان"}]
};

// --- الأيام بين أول وآخر يوم ---
const parseDate = d3.timeParse("%Y-%m-%d");
const formatDate = d3.timeFormat("%Y-%m-%d");
const firstDate = parseDate("1937-07-07");
const lastDate = parseDate("1938-10-01"); // مثال قصير يمكن التوسيع
const allDates = d3.timeDay.range(firstDate, d3.timeDay.offset(lastDate,1));

const slider = document.getElementById('timeSlider');
slider.min = 0;
slider.max = allDates.length-1;
slider.value = 0;

const dateLabel = document.getElementById('dateLabel');

// --- تحديث الخريطة يوميًا مع إبقاء الألوان ثابتة ---
function drawDay(idx){
  const dayObj = allDates[idx];
  const dayStr = formatDate(dayObj);
  dateLabel.textContent = dayStr;

  const dayEvents = eventsData[dayStr];
  if(dayEvents){
    dayEvents.forEach(ev=>{
      geojsonLayer.eachLayer(layer=>{
        if(layer.areaName === ev.area){
          layer.currentControl = ev.control;
          const color = (ev.control==='اليابان') ? 'blue' : 'red';
          layer.setStyle({fillColor:color, color:color, fillOpacity:0.6, weight:1});
          layer.bindPopup(`<b>${dayStr}</b><br/>${ev.desc}`);
        }
      });
    });
  }
}

drawDay(0);

// --- تشغيل وإيقاف ---
let timer=null;
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');

playBtn.addEventListener('click', ()=>{
  playBtn.style.display='none';
  pauseBtn.style.display='inline';
  let idx = parseInt(slider.value);
  timer = setInterval(()=>{
    if(idx >= allDates.length-1){
      clearInterval(timer);
      playBtn.style.display='inline';
      pauseBtn.style.display='none';
      return;
    }
    idx++;
    slider.value = idx;
    drawDay(idx);
  }, 200);
});

pauseBtn.addEventListener('click', ()=>{
  clearInterval(timer);
  playBtn.style.display='inline';
  pauseBtn.style.display='none';
});

slider.addEventListener('input', ()=> drawDay(slider.value));

</script>
</body>
</html>
