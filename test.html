<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>خريطة الحرب الصينية اليابانية WWII - ديناميكية</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; font-family: system-ui, Arial; direction: rtl; }
  #map { position: absolute; top:0; bottom:120px; left:0; right:0; }
  #controls { position:absolute; bottom:0; left:10px; right:10px; height:120px;
              background: rgba(255,255,255,0.95); border-radius:8px; padding:8px; display:flex; flex-direction:column; justify-content:center; gap:8px;}
  #legend { position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.9); padding:8px; border-radius:6px; }
  #dateLabel { font-weight:600; font-size:18px; }
  .eventPopup { font-size:13px; }
</style>
</head>
<body>

<div id="map"></div>
<div id="controls">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <button id="playBtn">تشغيل ▶</button>
    <button id="pauseBtn" style="display:none;">إيقاف ⏸</button>
    <div id="dateLabel">1937-07-07</div>
  </div>
  <input type="range" min="0" max="0" step="1" value="0" id="timeSlider" style="width:100%">
</div>

<div id="legend">
  <b>مفتاح الخريطة</b><br/>
  <span style="color:red;">■ مناطق تحرير / مقاومة</span><br/>
  <span style="color:blue;">■ مناطق احتلال ياباني</span><br/>
  <span>📝 الأحداث اليومية</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
// --- الخريطة ---
const map = L.map('map').setView([35,115], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- بيانات يومية للمناطق الملونة (احتلال/تحرير) ---
// كل يوم يمكن أن يحتوي على مناطق متعددة مع اللون
const dailyAreas = {
  "1937-07-07":[{bounds:[[30,115],[31,117]], color:"blue", desc:"احتلال اليابان منطقة صغيرة"}],
  "1937-08-13":[{bounds:[[30,115],[32,121]], color:"blue", desc:"توسيع الاحتلال الياباني"}],
  "1937-12-13":[{bounds:[[31,118],[32,119]], color:"red", desc:"تحرير جزء من المنطقة / مقاومة"}],
  "1938-10-01":[{bounds:[[30,112],[32,115]], color:"blue", desc:"احتلال جديد"}],
  "1941-12-07":[{bounds:[[21,107],[24,111]], color:"blue", desc:"احتلال جديد"}]
};

// --- إنشاء الأيام ---
const parseDate = d3.timeParse("%Y-%m-%d");
const formatDate = d3.timeFormat("%Y-%m-%d");
const startDate = parseDate("1937-07-07");
const endDate = parseDate("1945-08-15");
const allDates = d3.timeDay.range(startDate, endDate);

// --- ضبط السلايدر ---
const slider = document.getElementById('timeSlider');
slider.min = 0;
slider.max = allDates.length-1;
slider.value = 0;

// --- الطبقات ---
let activeLayers = [];
let eventPopup;

// --- رسم حسب اليوم ---
function drawMap(idx){
  const day = allDates[idx];
  const dayStr = formatDate(day);

  // إزالة الطبقات السابقة
  activeLayers.forEach(l=>map.removeLayer(l));
  activeLayers = [];
  if(eventPopup) map.removeLayer(eventPopup);

  // إضافة مناطق اليوم
  const areas = dailyAreas[dayStr];
  if(areas){
    areas.forEach(a=>{
      const layer = L.rectangle(a.bounds, {color:a.color, weight:1, fillColor:a.color, fillOpacity:0.5}).addTo(map);
      activeLayers.push(layer);
      // إضافة نافذة popup
      eventPopup = L.popup({closeOnClick:false, autoClose:false})
        .setLatLng([35,115])
        .setContent(`<div class="eventPopup"><b>${dayStr}</b><br/>${a.desc}</div>`)
        .openOn(map);
    });
  }

  document.getElementById('dateLabel').textContent = dayStr;
}

// --- السلايدر ---
slider.addEventListener('input', e=> drawMap(e.target.value));

// --- تشغيل / إيقاف ---
let timer=null;
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');

function play(){
  playBtn.style.display='none';
  pauseBtn.style.display='inline';
  let idx = parseInt(slider.value);
  timer = setInterval(()=>{
    if(idx >= allDates.length-1){
      clearInterval(timer);
      playBtn.style.display='inline';
      pauseBtn.style.display='none';
      return;
    }
    idx++;
    slider.value = idx;
    drawMap(idx);
  }, 200); // 200ms لكل يوم
}

function pause(){
  clearInterval(timer);
  playBtn.style.display='inline';
  pauseBtn.style.display='none';
}

playBtn.addEventListener('click', play);
pauseBtn.addEventListener('click', pause);

// --- أول عرض ---
drawMap(0);

</script>
</body>
</html>
