<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>خريطة الحرب الصينية اليابانية</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; font-family: system-ui, Arial; direction: rtl; }
  #map { position:absolute; top:0; bottom:80px; left:0; right:0; }
  #controls { position:absolute; left:10px; right:10px; bottom:10px; background:#fff; padding:6px; border-radius:6px; }
  #legend { position:absolute; top:10px; right:10px; background:#fff; padding:6px; border-radius:6px; }
</style>
</head>
<body>

<audio id="bgm" autoplay loop>
  <source src="war_music.mp3" type="audio/mpeg"/>
</audio>

<div id="map"></div>
<div id="controls">
  <button id="play">▶ تشغيل</button>
  <button id="pause">⏸ إيقاف</button>
  <input id="slider" type="range" min="0" max="8" value="0" style="width:200px"/>
  <span id="label"></span>
</div>
<div id="legend">
  <b>مفتاح الخريطة</b><br/>
  🔴 الصين<br/>
  🔵 اليابان
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-ajax"></script>
<script>

// إنشاء الخريطة
const map = L.map('map').setView([35,115], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// تحميل حدود الدول من GeoJSON (من Natural Earth عبر GitHub)
const chinaURL = "https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson";
const japanURL = "https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson";

let chinaLayer, japanLayer, occupiedLayer;

function styleChina() { return {color:"red", weight:1, fillColor:"red", fillOpacity:0.5}; }
function styleJapan() { return {color:"blue", weight:1, fillColor:"blue", fillOpacity:0.5}; }
function styleOccupied(opacity) { return {color:"blue", weight:0, fillColor:"blue", fillOpacity:opacity}; }

// جلب الصين
fetch(chinaURL).then(r=>r.json()).then(data=>{
  const chinaData = data.features.find(f=>f.properties.ADMIN==="China");
  chinaLayer = L.geoJSON(chinaData, {style: styleChina}).addTo(map);
});

// جلب اليابان
fetch(japanURL).then(r=>r.json()).then(data=>{
  const japanData = data.features.find(f=>f.properties.ADMIN==="Japan");
  japanLayer = L.geoJSON(japanData, {style: styleJapan}).addTo(map);
});

// متغيرات للتحكم بالزمن
const slider = document.getElementById("slider");
const label = document.getElementById("label");
let timer=null;

function update(frame){
  label.textContent="المرحلة "+(parseInt(frame)+1);
  
  // حذف طبقة الاحتلال القديمة إذا موجودة
  if(occupiedLayer){ map.removeLayer(occupiedLayer); }
  
  // كل مرحلة نزود شفافية الاحتلال الياباني داخل الصين
  const opacity = frame/10;
  if(chinaLayer){
    occupiedLayer = L.geoJSON(chinaLayer.toGeoJSON(), {style: styleOccupied(opacity)}).addTo(map);
  }
}

slider.addEventListener("input",e=>update(e.target.value));
document.getElementById("play").onclick=()=>{
  clearInterval(timer);
  timer=setInterval(()=>{
    let v=parseInt(slider.value);
    if(v>=parseInt(slider.max)){ clearInterval(timer); return; }
    v++; slider.value=v; update(v);
  },1000);
};
document.getElementById("pause").onclick=()=>clearInterval(timer);

// بدء أول مرة
update(0);

</script>
</body>
</html>
